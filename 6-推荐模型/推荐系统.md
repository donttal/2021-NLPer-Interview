# 推荐系统
[网址](https://blog.csdn.net/breakout_alex/article/details/106357575)

[toc]

本文主要包括推荐系统的相关概念、推荐系统的架构和流程、常见的推荐算法、挖掘、召回、排序、评估和总结这几部分。
## 通用推荐架构
整体技术框架：
![](http://image.woshipm.com/wp-files/2020/09/ztybyGUcbG1lCf53CoGt.jpeg)

比如已经产生了一个用户可能感兴趣物品的Top100，之后需要把用户已经买过的东西过滤掉。

然后再基于用户的一些历史行为进行排序，比如经常看的东西权重高一些，很久之前看的东西权重低一些，最终排一个名次，再按照排序名次取前10个展示给用户。

![](http://image.woshipm.com/wp-files/2020/09/EMXPkUo287WJbKm5JTPx.jpg)

用户特征部分做的事情主要是将用户的行为数据（点击、浏览、购买等）和属性数据（人口属性、用户关系、兴趣爱好等）转化为对应的特征，供用户-物品匹配部分利用。

物品候选集就是需要给用户匹配的物品，通常也需要转化为对应的物品特征。

有了物品特征和用户特征之后，需要做的就是生成用户-物品的初始化推荐列表。

再之后就是基于初始推荐列表的一些处理，过滤掉一些东西，按照用户的行为反馈、物品属性和一些产品策略再进行列表顺序的调整，生成最终的推荐结果。

### 通用推荐流程
上面主要是一些架构相关的东西，这部分主要是如何生成推荐结果。

理论上推荐流程可以分为挖掘——召回——排序这几部分。

![](http://image.woshipm.com/wp-files/2020/09/GgZBwMZavN0SBVtRM9L3.png)

挖掘就是上面说的用户特征和物品特征的生成部分，这部分做好了，后面的推荐结果才会有好的效果。

召回就是从原始的数据集中基于种种策略先挑选一部分物品，这部分需要尽可能全的覆盖用户需求，通常会把十万甚至百万级的候选集过滤到数百量级。

排序就是针对召回的数百个物品进行更深层次的加工，优先选择若干个结果推荐给用户，通常数量在数十级。

以上是理论上的流程，然而实际上每个部分都比较复杂，而且也不仅仅只有一个模型，通常情况下都会有N多模型，不同的模型用到的可能是不同的算法和策略。

### 1. 基于流行度的推荐
其实就是我们通常说的热门，基于最高评分、最多购买、最多下载、最多观看等维度给用户进行推荐。

通常情况下可以作为**冷启动策略**或者兜底的策略，前者是用户刚进来没有任何信息和行为偏好的时候，后者是在其他算法没有推荐结果的时候作为替补策略。

通常情况下计算规则基本都符合下面这个公式：

**热度分=（基础分+加权分+行为交互分）*时间衰减**

这里面会有很多变形，比如可能需要按照不同类目、维度给予不同的初始权重，可能会人工干预做一些升降权，不同行为的权重会不同等等。

### 2. 基于内容的推荐
首先澄清一个误解，基于内容的推荐包含有标签的推荐，但并不等于标签的推荐，标签只是基于内容推荐的一小部分。

标签、关键词、实体、分类、主题、词嵌入向量等，都是内容推荐中的一些手段。

基于内容推荐的核心是得到内容画像和用户画像，整体实现流程是先通过内容挖掘得到内容画像；然后基于用户的行为生成对应的用户画像，再基于用户画像和内容之间的相似度来给用户推荐不同的内容。

### 3. 近邻推荐
也就是大名鼎鼎的基于用户的协同过滤和基于物品的协同过滤。

#### 基于用户的协同过滤：

整体思想是找到和用户相似的群体，给用户推荐这群用户中比较流行但该用户没有听说过的东西。

比如A点击喜欢了一篇文章，这个时候就可以给A推荐Ta所在群体中其他人喜欢，但是A没有看过的文章。

这个策略的主要问题在于如何计算用户之间的相似度，通常的计算方法有两种：

计算用户之间的余弦相似度；
计算用户之间有正反馈物品的相似度，比如A喜欢了的文章和B喜欢了的文章有多少是重合的。

#### 基于物品的协同过滤：

用户协同过滤的思想是计算用户-用户的相似度，物品协同过滤就是基于物品-物品相似度的推荐，先找到用户喜欢过的物品最相似的物品列表，然后给用户推荐这些物品。

只不过这个物品-物品的相似度并不是直接计算得到的，而是通过喜欢物品一的用户和喜欢物品二的用户的交集来计算的，两个物品相似是因为它们出现在很多共同用户的喜好列表中。

这里面需要注意的是热门物品和其他物品之间的相似度，理论上来说大多数用户都可能会喜欢热门物品，这样就可能造成热门物品-单个物品的相似度很高，所以需要适当的对热门物品进行降权处理。

### 4. 矩阵分解
矩阵分解可以看作是隐语义模型的一种实现方式，核心是为了获得物品和用户的隐向量，然后基于隐向量进行后续的计算和推荐。

近邻推荐是基于用户——用户或者用户——物品矩阵中已有的数据去计算未知的数据，矩阵分解则是将这个矩阵分解为两个小矩阵，后续的计算不再使用原始矩阵，而是采用这两个小矩阵。
![](http://image.woshipm.com/wp-files/2020/09/FQLp0aTCiVKvx5n0MOQw.jpg)

比如分解用户-物品矩阵后得到用户u的向量是 Pu，物品i的向量是Qi，那么要计算物品i推荐给用户u的推荐分数，直接计算点积即可。

矩阵分解有时也被称作SVD，但SVD 和矩阵分解不能划等号，因为除了SVD还有一些别的矩阵分解方法。

比如加了用户隐式反馈行为和属性的SVD++，加了时间因素的Time-SVD，还有用来求解矩阵的交替最小二乘法ALS等。

### 5. 基于关联规则的推荐
关联规则更多是基于统计模型的推荐，表现形式为A和B有很大的关联性，买了A我就给你推荐B。

通常在电商中运用的比较多，比如买了个炒锅为你推荐锅铲，买了个手机为你推荐耳机等。

### 6. 基于图模型的推荐
图模型指的是把用户行为表示为二分图模型，将个性化推荐算法放到二分图模型上。

那给用户u推荐物品的问题就可以转化为度量用户顶点Vu和与它没有边相连的物品顶点在图上的相关性，相关性越高，物品在推荐列表中的权重越高。

深度学习：CNN、RNN等。

### 7. 混合推荐
加权指的给不同的算法赋予不同的权重，将多个算法的推荐结果组合在一起，然后取TopN；
交叉指的是直接将不同算法的结果推荐给用户，比如固定位置展示或者按照百分比出；
切换指的是在不同的场景下采用不同的算法，比如资讯类产品优先基于内容推荐，找不到合适的内容再基于协同过滤，最后基于热门；
分级指的是按照算法的效果好坏进行使用，优先使用效果好的算法，无推荐结果时再使用次好的算法；
分层指的是把前一层算法输出的结果作为后一层的输入结果，然后再不断的进行优化。
以上，就是常用算法相关的内容，后面是基于推荐流程展开的内容，分别是挖掘、召回和排序。

## 四、挖掘
### 1. 整体流程
特征工程整体流程大致可以分为特征清洗、特征预处理、特征处理和特征监控这几部分。

特征清洗主要是将一些异常样本进行清洗，对一些样本进行采样。

特征预处理主要是对单个特征类型的一些转换，同时对异常值、缺失值进行处理，此外还有对多个特征的降维、选择。

特征处理主要是对特征进行离散、平滑、组合、聚合等处理，以达到更好的效果。

特征监控一方面是对特征的有效性进行分析，看特征是否真的有效，另一方面是监控特征的重要性是否有变化，避免影响模型效果。

### 2. 常见的特征
常见的特征可以分为用户特征、物品特征、相关性特征、环境特征、上下文特征等。

用户特征指的是自然属性（姓名、性别、年龄等）、画像特征（兴趣爱好、行为等）、关系特征（人群属性、亲密度、关注关系等）。

物品特征可以分为静态和动态两大类，静态指的是物品的固有属性，如分类、标签、关键词、主题、类型、语义等，动态指的是全局热度、分类热度、关键词热度等。

相关性特征指的是分类匹配、关键词匹配、语义匹配、uid-mid匹配、点击相似、兴趣分类相似、主题相似、兴趣词相似、向量相似等。

环境特征指的是时间、地点、网络环境、天气等。

上下文指的是用户最近N条浏览内容、点击内容，或者是内容的相关内容，内容发布者的其他内容等。

## 五、召回
通常情况下候选集的数量可能有十万，百万甚至千万的量级，这种情况下如果直接计算用户相似度或者物品相似度的话，复杂度会非常高，成本也会非常大。

召回这个环节的主要任务就是从大规模的候选集中初步筛选出来一部分内容，供后续的排序环节使用，所以这个环节需要覆盖很广很全的范围。

召回的触发机制主要是基于用户特征和环境特征，比如用户画像相关、兴趣相关、行为相关、上下文相关等；此外还有一些运营规则和产品策略，比如热门、特定类型提权、降权等。

常见的召回策略包括上文算法部分的那些算法，以及一些其他策略，比如基于热门、内容、协同过滤、关联规则、图模型、地理位置、时间、用户关系等的召回策略。

有了初步的召回集之后，就可以考虑一些过滤规则了，比如过滤掉用户曾经购买过、明确表示过不喜欢的物品或者已经失去了时效性的物品等。

## 六、排序
按照排序类型来划分的话，排序可以分为粗排和精排，按照目标来划分的话，排序可以分为单目标排序和多目标排序。

单目标和多目标倒还好理解一些，毕竟不同的目标需要的模型和策略可能是不同的，那为什么类型又区分成粗排和精排。

主要可以分为两方面的原因，一方面大多数用户其实消费不了那么多内容，我们精心为用户准备了Top100的内容，大多数情况下用户可能只消费10条内容，那90条内容的工作量可能就浪费了；另一方面排序的核心任务是对召回集给出的结果进行精准的排序，需要兼顾很多模型和特征，这就需要在效率、成本和性能之间做平衡了。

基于这两点原因，将排序又分为了粗排和精排两个阶段。

粗排阶段处理的物品数量在数百级，主要负责对召回的物品进行打分，也可以理解为用户的感兴趣程度。
精排阶段处理的物品在数十级，同时还会有一些产品规则方面的考虑，比如对于多样性、新颖性、兴趣探索方面的考虑，以及对于特定内容的加权、过滤或者强制隔离等。
单目标排序比较常见的是CTR（点击率）预估，当然这个C并不一定只能是Click，也可以是其他任何行为。

比如视频是不是会看完，看完后是不是会收藏，是不是会分享到第三方平台，查看的商品是不是会购买等，这些都可以看成那个可以被预估发生概率的CTR。

多目标顾名思义就是在排序阶段希望能够满足多个目标，比如视频的点击率+停留时长+完播率，电商的点击率+购买率+客单价。

**知乎的排序模型就是一个多目标模型，有基于点击率的模型，基于收藏率的模型，基于点赞率，基于评论率等一共8个目标。**

排序模型一般用目标值和AUC来进行衡量，目标值就是排序模型最开始的目标，点击率、停留时长、购买率等。

AUC全称是Area Under Curve，意思是曲线下的面积，这里的曲线就是ROC曲线，这个值在数学上等价于模型把关心的那一类样本排在其他样本前面的概率。

AUC最大是1，完美结果，0.5就是随机排列，0就是完美地全部排错，当然0也可以变成1，效果最差的其实是0.5左右的。

### 1. 评估
用户满意度：点击率，用户停留时长，转化率等指标。

预测准确度：分为评分预测和TopN预测。

评分预测主要是通过RMSE来衡量，即预测评分和真实评分之间的均方根误差。
TopN预测主要是用召回率和准确率来进行衡量。
召回率=推荐数与有反馈数的交集/有反馈数

准确率=推荐数与有反馈数的交集/推荐数

覆盖率：推荐系统能够推荐出来的物品，占总物品集合的比例。

多样性：描述的是推荐列表中物品两两之间的不相似性，希望尽可能多的覆盖用户的兴趣点。

新颖性：给用户推荐那些他们以前没有见过的东西。

惊喜度：给用户的推荐结果是和用户历史上喜欢的物品不相似，但用户却又觉得满意的推荐。

信任度：增加推荐系统的透明度，让用户知道推荐的理由；比如为什么给用户推荐了这个东西，可能是历史基于历史的某次行为，也可能是基于某个好友信息。

实时性：能够实时更新推荐列表，来满足用户行为的变化，能够将新加入系统的物品推荐给用户。

健壮性：推荐系统抗击作弊的能力。

商业目标：能否满足商业需求，比如GMV、广告收入等。


